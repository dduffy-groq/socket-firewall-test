# CI Pipeline with Socket Firewall (sfw)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Socket Firewall protected install
  socket-protected-install:
    name: Socket Firewall Install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Socket Firewall (sfw)
        run: npm install -g sfw
      
      - name: Clear npm cache (required for sfw to intercept)
        run: npm cache clean --force
      
      - name: Display dependencies to install
        run: |
          echo "=== package.json dependencies ==="
          cat package.json | jq '.dependencies'
          echo ""
          echo "=== socket.yml ==="
          cat socket.yml
      
      - name: Install with Socket Firewall protection
        id: sfw-install
        run: |
          echo "=== Running: sfw npm install ==="
          echo ""
          echo "Socket Firewall will intercept and check each package..."
          echo ""
          
          sfw npm install 2>&1 | tee sfw-output.txt
          SFW_EXIT=$?
          
          echo ""
          echo "=== sfw exit code: $SFW_EXIT ==="
          
          if [ $SFW_EXIT -ne 0 ]; then
            echo "ðŸš« Socket Firewall blocked installation!"
            exit 1
          else
            echo "âœ… All dependencies passed Socket Firewall checks"
          fi
      
      - name: Upload sfw output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sfw-install-output
          path: sfw-output.txt
          retention-days: 7

  # Build job - only runs if sfw install passes
  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: socket-protected-install
    if: ${{ always() && needs.socket-protected-install.result == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install sfw and dependencies
        run: |
          npm install -g sfw
          npm cache clean --force
          sfw npm install express@4.18.2 lodash@4.17.21 --ignore-scripts
          sfw npm install jest@29.7.0 --save-dev --ignore-scripts
      
      - name: Run build
        run: node src/build.js
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/
          retention-days: 7

  # Test job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    if: ${{ always() && needs.build.result == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install sfw and safe dependencies
        run: |
          npm install -g sfw
          npm cache clean --force
          sfw npm install express@4.18.2 lodash@4.17.21 --ignore-scripts
      
      - name: Run tests
        run: node src/test.js
