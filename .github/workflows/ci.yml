# CI Pipeline with Socket Security Check (Free Tier)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Socket Security Check - uses free tier (no API key required)
  socket-security:
    name: Socket Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Display Socket Policy
        run: |
          echo "=== socket.yml configuration ==="
          cat socket.yml
          echo ""
          echo "=== Dependencies to check ==="
          cat package.json | jq '.dependencies'
      
      - name: Check for protestware before install
        id: check-protestware
        run: |
          echo "=== Pre-install Protestware Check ==="
          BLOCKED=0
          
          # Check for faker (protestware that still exists on npm)
          if grep -q '"faker"' package.json; then
            VERSION=$(cat package.json | jq -r '.dependencies.faker // empty')
            if [ -n "$VERSION" ]; then
              echo "‚ùå BLOCKED: faker@$VERSION (protestware)"
              echo "   This package was intentionally corrupted by its author."
              BLOCKED=1
            fi
          fi
          
          if [ $BLOCKED -gt 0 ]; then
            echo ""
            echo "üö´ PROTESTWARE DETECTED - Blocking build"
            exit 1
          else
            echo "‚úÖ No protestware detected in dependencies"
          fi
      
      - name: Upload Security Scan Output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: socket-scan-output
          path: |
            socket-output.txt
            npm-audit.txt
          retention-days: 7
          if-no-files-found: ignore

  # Build job - only runs if security check passes
  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    needs: socket-security
    if: ${{ always() && needs.socket-security.result == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install safe dependencies only
        run: |
          # Only install packages that aren't protestware
          npm install express@4.18.2 lodash@4.17.21 --ignore-scripts
          npm install jest@29.7.0 --save-dev --ignore-scripts
      
      - name: Run build
        run: node src/build.js
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/
          retention-days: 7

  # Test job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    if: ${{ always() && needs.build.result == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install safe dependencies
        run: npm install express@4.18.2 lodash@4.17.21 --ignore-scripts
      
      - name: Run tests
        run: node src/test.js
