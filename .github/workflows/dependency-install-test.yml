# Dependency Installation Test
#
# Tests Socket's BUILT-IN detection (no explicit package rules)

name: Dependency Install Test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # Test npm audit built-in detection
  npm-audit-detection:
    name: npm audit Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create package-lock.json
        run: npm install --package-lock-only --ignore-scripts 2>/dev/null || true
      
      - name: Run npm audit
        run: |
          echo "=== Testing npm audit built-in detection ==="
          echo ""
          echo "Dependencies in package.json:"
          cat package.json | jq '.dependencies'
          echo ""
          
          echo "=== npm audit output ==="
          npm audit 2>&1
          
          echo ""
          echo "If npm audit exits with non-zero, it detected issues!"

  # Test Socket CLI built-in detection
  socket-cli-detection:
    name: Socket CLI Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Create package-lock.json
        run: npm install --package-lock-only --ignore-scripts 2>/dev/null || true
      
      - name: Install and run Socket CLI
        run: |
          echo "=== Installing Socket CLI ==="
          npm install -g @socketsecurity/cli || true
          
          echo ""
          echo "=== Socket CLI scan ==="
          npx @socketsecurity/cli npm audit 2>&1 || true

  # Summary job
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [npm-audit-detection, socket-cli-detection]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "=== Built-in Detection Test Summary ==="
          echo ""
          echo "This test verifies Socket/npm detects faker@6.6.6 WITHOUT explicit rules"
          echo ""
          echo "socket.yml contains:"
          echo "  - issueRules with 'protestware: error'"
          echo "  - NO deferredPackageRules (explicit blocking removed)"
          echo ""
          echo "Results:"
          echo "  - npm-audit-detection: ${{ needs.npm-audit-detection.result }}"
          echo "  - socket-cli-detection: ${{ needs.socket-cli-detection.result }}"
